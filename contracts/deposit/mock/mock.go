package mock

import (
	"crypto/ecdsa"
	"fmt"
	"math/big"
	"strings"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/accounts/abi/bind/backends"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/prysmaticlabs/prysm/v3/contracts/deposit"
)

var (
	amount32Eth        = "32000000000000000000"
	amountLessThan1Eth = "500000000000000000"
	depositContractBin = "0x60806040523480156200001157600080fd5b5060005b6001602062000025919062000155565b811015620001155760026021826020811062000046576200004562000190565b5b0154602183602081106200005f576200005e62000190565b5b015460405160200162000074929190620001ee565b60405160208183030381529060405260405162000092919062000297565b602060405180830381855afa158015620000b0573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190620000d59190620002e6565b6021600183620000e6919062000318565b60208110620000fa57620000f962000190565b5b018190555080806200010c9062000353565b91505062000015565b50620003a0565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600062000162826200011c565b91506200016f836200011c565b92508282039050818111156200018a576200018962000126565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000819050919050565b6000819050919050565b620001e8620001e282620001bf565b620001c9565b82525050565b6000620001fc8285620001d3565b6020820191506200020e8284620001d3565b6020820191508190509392505050565b600081519050919050565b600081905092915050565b60005b838110156200025457808201518184015260208101905062000237565b60008484015250505050565b60006200026d826200021e565b62000279818562000229565b93506200028b81856020860162000234565b80840191505092915050565b6000620002a5828462000260565b915081905092915050565b600080fd5b620002c081620001bf565b8114620002cc57600080fd5b50565b600081519050620002e081620002b5565b92915050565b600060208284031215620002ff57620002fe620002b0565b5b60006200030f84828501620002cf565b91505092915050565b600062000325826200011c565b915062000332836200011c565b92508282019050808211156200034d576200034c62000126565b5b92915050565b600062000360826200011c565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820362000395576200039462000126565b5b600182019050919050565b6121a680620003b06000396000f3fe60806040526004361061003f5760003560e01c806301ffc9a714610044578063621fd13014610081578063af9dbc1b146100ac578063c5f2892f146100c8575b600080fd5b34801561005057600080fd5b5061006b600480360381019061006691906110fb565b6100f3565b6040516100789190611143565b60405180910390f35b34801561008d57600080fd5b506100966101c5565b6040516100a391906111ee565b60405180910390f35b6100c660048036038101906100c1919061133f565b6101d7565b005b3480156100d457600080fd5b506100dd6105f7565b6040516100ea919061143d565b60405180910390f35b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614806101be57507f0870e404000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b9050919050565b60606101d26020546107d8565b905090565b6030898990501461021d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610214906114db565b60405180910390fd5b60208787905014610263576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161025a9061156d565b60405180910390fd5b606085859050146102a9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102a0906115ff565b60405180910390fd5b670de0b6b3a76400003410156102f4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102eb90611691565b60405180910390fd5b6000633b9aca003461030691906116e0565b14610346576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161033d90611783565b60405180910390fd5b6000633b9aca003461035891906117d2565b905067ffffffffffffffff80168111156103a7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161039e90611875565b60405180910390fd5b60006103b2826107d8565b905060006103bf846107d8565b90507f0cff1634a9a72df9d813ea7e3a3874a76086e081904ad3cf81e12e43f4d4c87a8c8c8c8c868d8d6103f46020546107d8565b6103fd8e610b10565b8a6040516104149a999897969594939291906118d1565b60405180910390a1600061042f8d8d8d8d8d8d898d8a610b5b565b9050868114610473576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161046a90611a0f565b60405180910390fd5b6001602060026104839190611b62565b61048d9190611bad565b602054106104d0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104c790611c53565b60405180910390fd5b6001602060008282546104e39190611c73565b925050819055506000602054905060005b60208110156105d65760018083160361052c57826000826020811061051c5761051b611ca7565b5b01819055505050505050506105ec565b60026000826020811061054257610541611ca7565b5b015484604051602001610556929190611cf7565b6040516020818303038152906040526040516105729190611d5f565b602060405180830381855afa15801561058f573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906105b29190611d8b565b92506002826105c191906117d2565b915080806105ce90611db8565b9150506104f4565b5060006105e6576105e5611e00565b5b50505050505b505050505050505050565b6000806000602054905060005b602081101561074f576001808316036106a45760026000826020811061062d5761062c611ca7565b5b015484604051602001610641929190611cf7565b60405160208183030381529060405260405161065d9190611d5f565b602060405180830381855afa15801561067a573d6000803e3d6000fd5b5050506040513d601f19601f8201168201806040525081019061069d9190611d8b565b925061072d565b600283602183602081106106bb576106ba611ca7565b5b01546040516020016106ce929190611cf7565b6040516020818303038152906040526040516106ea9190611d5f565b602060405180830381855afa158015610707573d6000803e3d6000fd5b5050506040513d601f19601f8201168201806040525081019061072a9190611d8b565b92505b60028261073a91906117d2565b9150808061074790611db8565b915050610604565b5060028261075e6020546107d8565b600060401b60405160200161077593929190611e7c565b6040516020818303038152906040526040516107919190611d5f565b602060405180830381855afa1580156107ae573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906107d19190611d8b565b9250505090565b6060600867ffffffffffffffff8111156107f5576107f4611eb5565b5b6040519080825280601f01601f1916602001820160405280156108275781602001600182028036833780820191505090505b50905060008260c01b90508060076008811061084657610845611ca7565b5b1a60f81b8260008151811061085e5761085d611ca7565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350806006600881106108a1576108a0611ca7565b5b1a60f81b826001815181106108b9576108b8611ca7565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350806005600881106108fc576108fb611ca7565b5b1a60f81b8260028151811061091457610913611ca7565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508060046008811061095757610956611ca7565b5b1a60f81b8260038151811061096f5761096e611ca7565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350806003600881106109b2576109b1611ca7565b5b1a60f81b826004815181106109ca576109c9611ca7565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080600260088110610a0d57610a0c611ca7565b5b1a60f81b82600581518110610a2557610a24611ca7565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080600160088110610a6857610a67611ca7565b5b1a60f81b82600681518110610a8057610a7f611ca7565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080600060088110610ac357610ac2611ca7565b5b1a60f81b82600781518110610adb57610ada611ca7565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535050919050565b606060405173ffffffffffffffffffffffffffffffffffffffff8316925082741400000000000000000000000000000000000000001860148201526034810160405280915050919050565b60008060028b8b600060801b604051602001610b7993929190611f56565b604051602081830303815290604052604051610b959190611d5f565b602060405180830381855afa158015610bb2573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610bd59190611d8b565b905060006002808989600090604092610bf093929190611f8a565b604051602001610c01929190611fc5565b604051602081830303815290604052604051610c1d9190611d5f565b602060405180830381855afa158015610c3a573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610c5d9190611d8b565b60028a8a6040908092610c7293929190611f8a565b6000801b604051602001610c8893929190611fde565b604051602081830303815290604052604051610ca49190611d5f565b602060405180830381855afa158015610cc1573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610ce49190611d8b565b604051602001610cf5929190611cf7565b604051602081830303815290604052604051610d119190611d5f565b602060405180830381855afa158015610d2e573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610d519190611d8b565b90506000600280848d8d604051602001610d6d93929190612008565b604051602081830303815290604052604051610d899190611d5f565b602060405180830381855afa158015610da6573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610dc99190611d8b565b600289600060401b86604051602001610de493929190612032565b604051602081830303815290604052604051610e009190611d5f565b602060405180830381855afa158015610e1d573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610e409190611d8b565b604051602001610e51929190611cf7565b604051602081830303815290604052604051610e6d9190611d5f565b602060405180830381855afa158015610e8a573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610ead9190611d8b565b9050600060028088600060a01b89600060401b604051602001610ed39493929190612100565b604051602081830303815290604052604051610eef9190611d5f565b602060405180830381855afa158015610f0c573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610f2f9190611d8b565b60026000801b6000801b604051602001610f4a929190611cf7565b604051602081830303815290604052604051610f669190611d5f565b602060405180830381855afa158015610f83573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190610fa69190611d8b565b604051602001610fb7929190611cf7565b604051602081830303815290604052604051610fd39190611d5f565b602060405180830381855afa158015610ff0573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906110139190611d8b565b90506002828260405160200161102a929190611cf7565b6040516020818303038152906040526040516110469190611d5f565b602060405180830381855afa158015611063573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906110869190611d8b565b9450505050509998505050505050505050565b600080fd5b600080fd5b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b6110d8816110a3565b81146110e357600080fd5b50565b6000813590506110f5816110cf565b92915050565b60006020828403121561111157611110611099565b5b600061111f848285016110e6565b91505092915050565b60008115159050919050565b61113d81611128565b82525050565b60006020820190506111586000830184611134565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561119857808201518184015260208101905061117d565b60008484015250505050565b6000601f19601f8301169050919050565b60006111c08261115e565b6111ca8185611169565b93506111da81856020860161117a565b6111e3816111a4565b840191505092915050565b6000602082019050818103600083015261120881846111b5565b905092915050565b600080fd5b600080fd5b600080fd5b60008083601f84011261123557611234611210565b5b8235905067ffffffffffffffff81111561125257611251611215565b5b60208301915083600182028301111561126e5761126d61121a565b5b9250929050565b6000819050919050565b61128881611275565b811461129357600080fd5b50565b6000813590506112a58161127f565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006112d6826112ab565b9050919050565b6112e6816112cb565b81146112f157600080fd5b50565b600081359050611303816112dd565b92915050565b6000819050919050565b61131c81611309565b811461132757600080fd5b50565b60008135905061133981611313565b92915050565b600080600080600080600080600060c08a8c03121561136157611360611099565b5b60008a013567ffffffffffffffff81111561137f5761137e61109e565b5b61138b8c828d0161121f565b995099505060208a013567ffffffffffffffff8111156113ae576113ad61109e565b5b6113ba8c828d0161121f565b975097505060408a013567ffffffffffffffff8111156113dd576113dc61109e565b5b6113e98c828d0161121f565b955095505060606113fc8c828d01611296565b935050608061140d8c828d016112f4565b92505060a061141e8c828d0161132a565b9150509295985092959850929598565b61143781611275565b82525050565b6000602082019050611452600083018461142e565b92915050565b600082825260208201905092915050565b7f4465706f736974436f6e74726163743a20696e76616c6964207075626b65792060008201527f6c656e6774680000000000000000000000000000000000000000000000000000602082015250565b60006114c5602683611458565b91506114d082611469565b604082019050919050565b600060208201905081810360008301526114f4816114b8565b9050919050565b7f4465706f736974436f6e74726163743a20696e76616c6964207769746864726160008201527f77616c5f63726564656e7469616c73206c656e67746800000000000000000000602082015250565b6000611557603683611458565b9150611562826114fb565b604082019050919050565b600060208201905081810360008301526115868161154a565b9050919050565b7f4465706f736974436f6e74726163743a20696e76616c6964207369676e61747560008201527f7265206c656e6774680000000000000000000000000000000000000000000000602082015250565b60006115e9602983611458565b91506115f48261158d565b604082019050919050565b60006020820190508181036000830152611618816115dc565b9050919050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c7565207460008201527f6f6f206c6f770000000000000000000000000000000000000000000000000000602082015250565b600061167b602683611458565b91506116868261161f565b604082019050919050565b600060208201905081810360008301526116aa8161166e565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60006116eb82611309565b91506116f683611309565b925082611706576117056116b1565b5b828206905092915050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c7565206e60008201527f6f74206d756c7469706c65206f66206777656900000000000000000000000000602082015250565b600061176d603383611458565b915061177882611711565b604082019050919050565b6000602082019050818103600083015261179c81611760565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006117dd82611309565b91506117e883611309565b9250826117f8576117f76116b1565b5b828204905092915050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c7565207460008201527f6f6f206869676800000000000000000000000000000000000000000000000000602082015250565b600061185f602783611458565b915061186a82611803565b604082019050919050565b6000602082019050818103600083015261188e81611852565b9050919050565b82818337600083830152505050565b60006118b08385611169565b93506118bd838584611895565b6118c6836111a4565b840190509392505050565b600060e08201905081810360008301526118ec818c8e6118a4565b90508181036020830152611901818a8c6118a4565b9050818103604083015261191581896111b5565b9050818103606083015261192a8187896118a4565b9050818103608083015261193e81866111b5565b905081810360a083015261195281856111b5565b905081810360c083015261196681846111b5565b90509b9a5050505050505050505050565b7f4465706f736974436f6e74726163743a207265636f6e7374727563746564204460008201527f65706f7369744461746120646f6573206e6f74206d6174636820737570706c6960208201527f6564206465706f7369745f646174615f726f6f74000000000000000000000000604082015250565b60006119f9605483611458565b9150611a0482611977565b606082019050919050565b60006020820190508181036000830152611a28816119ec565b9050919050565b60008160011c9050919050565b6000808291508390505b6001851115611a8657808604811115611a6257611a616117a3565b5b6001851615611a715780820291505b8081029050611a7f85611a2f565b9450611a46565b94509492505050565b600082611a9f5760019050611b5b565b81611aad5760009050611b5b565b8160018114611ac35760028114611acd57611afc565b6001915050611b5b565b60ff841115611adf57611ade6117a3565b5b8360020a915084821115611af657611af56117a3565b5b50611b5b565b5060208310610133831016604e8410600b8410161715611b315782820a905083811115611b2c57611b2b6117a3565b5b611b5b565b611b3e8484846001611a3c565b92509050818404811115611b5557611b546117a3565b5b81810290505b9392505050565b6000611b6d82611309565b9150611b7883611309565b9250611ba57fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484611a8f565b905092915050565b6000611bb882611309565b9150611bc383611309565b9250828203905081811115611bdb57611bda6117a3565b5b92915050565b7f4465706f736974436f6e74726163743a206d65726b6c6520747265652066756c60008201527f6c00000000000000000000000000000000000000000000000000000000000000602082015250565b6000611c3d602183611458565b9150611c4882611be1565b604082019050919050565b60006020820190508181036000830152611c6c81611c30565b9050919050565b6000611c7e82611309565b9150611c8983611309565b9250828201905080821115611ca157611ca06117a3565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000819050919050565b611cf1611cec82611275565b611cd6565b82525050565b6000611d038285611ce0565b602082019150611d138284611ce0565b6020820191508190509392505050565b600081905092915050565b6000611d398261115e565b611d438185611d23565b9350611d5381856020860161117a565b80840191505092915050565b6000611d6b8284611d2e565b915081905092915050565b600081519050611d858161127f565b92915050565b600060208284031215611da157611da0611099565b5b6000611daf84828501611d76565b91505092915050565b6000611dc382611309565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611df557611df46117a3565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052600160045260246000fd5b60007fffffffffffffffffffffffffffffffffffffffffffffffff000000000000000082169050919050565b6000819050919050565b611e76611e7182611e2f565b611e5b565b82525050565b6000611e888286611ce0565b602082019150611e988285611d2e565b9150611ea48284611e65565b601882019150819050949350505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000611ef08385611d23565b9350611efd838584611895565b82840190509392505050565b60007fffffffffffffffffffffffffffffffff0000000000000000000000000000000082169050919050565b6000819050919050565b611f50611f4b82611f09565b611f35565b82525050565b6000611f63828587611ee4565b9150611f6f8284611f3f565b601082019150819050949350505050565b600080fd5b600080fd5b60008085851115611f9e57611f9d611f80565b5b83861115611faf57611fae611f85565b5b6001850283019150848603905094509492505050565b6000611fd2828486611ee4565b91508190509392505050565b6000611feb828587611ee4565b9150611ff78284611ce0565b602082019150819050949350505050565b60006120148286611ce0565b602082019150612025828486611ee4565b9150819050949350505050565b600061203e8286611d2e565b915061204a8285611e65565b60188201915061205a8284611ce0565b602082019150819050949350505050565b60008160601b9050919050565b60006120838261206b565b9050919050565b600061209582612078565b9050919050565b6120ad6120a8826112cb565b61208a565b82525050565b60007fffffffffffffffffffffffff000000000000000000000000000000000000000082169050919050565b6000819050919050565b6120fa6120f5826120b3565b6120df565b82525050565b600061210c828761209c565b60148201915061211c82866120e9565b600c8201915061212c8285611d2e565b91506121388284611e65565b6018820191508190509594505050505056fea264697066735822122033af04905a1275e18c75c42d00c8def999892cade7791c180252b04afdb8d8ac64736f6c637828302e382e31372d646576656c6f702e323032322e382e32392b636f6d6d69742e37626665633362610059"
)

// TestAccount represents a test account in the simulated backend,
// through which we can perform actions on the eth1.0 chain.
type TestAccount struct {
	Addr         common.Address
	ContractAddr common.Address
	Contract     *deposit.DepositContract
	Backend      *backends.SimulatedBackend
	TxOpts       *bind.TransactOpts
}

// Setup creates the simulated backend with the deposit contract deployed
func Setup() (*TestAccount, error) {
	genesis := make(core.GenesisAlloc)
	privKey, err := crypto.GenerateKey()
	if err != nil {
		return nil, err
	}
	pubKeyECDSA, ok := privKey.Public().(*ecdsa.PublicKey)
	if !ok {
		return nil, fmt.Errorf("error casting public key to ECDSA")
	}

	// strip off the 0x and the first 2 characters 04 which is always the EC prefix and is not required.
	publicKeyBytes := crypto.FromECDSAPub(pubKeyECDSA)[4:]
	var pubKey = make([]byte, 48)
	copy(pubKey, publicKeyBytes)

	addr := crypto.PubkeyToAddress(privKey.PublicKey)
	txOpts, err := bind.NewKeyedTransactorWithChainID(privKey, big.NewInt(1337))
	if err != nil {
		return nil, err
	}
	startingBalance, _ := new(big.Int).SetString("100000000000000000000000000000000000000", 10)
	genesis[addr] = core.GenesisAccount{Balance: startingBalance}
	backend := backends.NewSimulatedBackend(genesis, 210000000000)

	contractAddr, _, contract, err := DeployDepositContract(txOpts, backend)
	if err != nil {
		return nil, err
	}
	backend.Commit()

	return &TestAccount{addr, contractAddr, contract, backend, txOpts}, nil
}

// Amount32Eth returns 32Eth(in wei) in terms of the big.Int type.
func Amount32Eth() *big.Int {
	amount, _ := new(big.Int).SetString(amount32Eth, 10)
	return amount
}

// LessThan1Eth returns less than 1 Eth(in wei) in terms of the big.Int type.
func LessThan1Eth() *big.Int {
	amount, _ := new(big.Int).SetString(amountLessThan1Eth, 10)
	return amount
}

// DeployDepositContract deploys a new Ethereum contract, binding an instance of DepositContract to it.
func DeployDepositContract(auth *bind.TransactOpts, backend bind.ContractBackend) (common.Address, *types.Transaction, *deposit.DepositContract, error) {
	parsed, err := abi.JSON(strings.NewReader(deposit.DepositContractABI))
	if err != nil {
		return common.Address{}, nil, nil, err
	}

	address, tx, contract, err := bind.DeployContract(auth, parsed, common.FromHex(depositContractBin), backend)
	if err != nil {
		fmt.Println()
		return common.Address{}, nil, nil, err
	}
	return address, tx, &deposit.DepositContract{
		DepositContractCaller:     deposit.NewDepositContractCallerFromBoundContract(contract),
		DepositContractTransactor: deposit.NewDepositContractTransactorFromBoundContract(contract),
		DepositContractFilterer:   deposit.NewDepositContractFiltererFromBoundContract(contract),
	}, nil
}
